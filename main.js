(() => {\n  'use strict';\n  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));\n  const rand = (a,b)=>Math.random()*(b-a)+a;\n  const now = ()=>performance.now();\n\n  // Audio helper\n  const Audio = (()=>{ let ctx=null, enabled=true; const ensure=()=>{ if(!ctx){ try{ ctx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } return ctx; }; const toggle=()=>{ enabled=!enabled; return enabled; }; const resume=()=>{ if(ctx && ctx.state==='suspended') ctx.resume(); }; const beep=(freq=440, dur=0.08, type='sine', vol=0.1)=>{ if(!enabled) return; const c=ensure(); if(!c) return; const o=c.createOscillator(); const g=c.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g).connect(c.destination); const t=c.currentTime; o.start(t); o.stop(t+dur); g.gain.exponentialRampToValueAtTime(0.0001, t+dur); }; return { ensure, toggle, resume, beep, get enabled(){ return enabled; } }; })();\n\n  // Local storage wrapper\n  const Storage = {\n    getName(){ return (localStorage.getItem('player_name')||'').trim(); },\n    setName(n){ localStorage.setItem('player_name', n); },\n    getBest(){ return Number(localStorage.getItem('best')||0); },\n    setBest(v){ localStorage.setItem('best', String(v|0)); },\n    getBoard(){ try { return JSON.parse(localStorage.getItem('leaderboard')||'[]'); } catch { return []; } },\n    setBoard(arr){ localStorage.setItem('leaderboard', JSON.stringify(arr)); }\n  };\n\n  const NAME_MAX = 12;\n  const sanitizeName = (s)=>{\n    return (s||'').toString().replace(/\\s+/g,' ').trim().slice(0, NAME_MAX);\n  };\n\n  function submitScore(name, score){\n    const n = sanitizeName(name)||'Player';\n    const entry = { name: n, score: score|0, t: Date.now() };\n    const board = Storage.getBoard();\n    board.push(entry);\n    board.sort((a,b)=> b.score - a.score || a.t - b.t);\n    const TOP = 10;\n    const trimmed = board.slice(0, TOP);\n    Storage.setBoard(trimmed);\n    const rank = trimmed.findIndex(e => e === entry) + 1; // 1-based if remained in top\n    return { rank: rank>0?rank:null, board: trimmed };\n  }\n\n  function renderBoard(listEl, board){\n    if(!listEl) return;\n    listEl.innerHTML = '';\n    const frag = document.createDocumentFragment();\n    board.forEach((e,i)=>{\n      const li = document.createElement('li');\n      li.innerHTML = `<span class=\"pos\">${i+1}</span> <span class=\"nm\">${e.name.replace(/</g,'&lt;')}</span> <span class=\"sc\">${e.score}</span>`;\n      frag.appendChild(li);\n    });\n    listEl.appendChild(frag);\n  }\n\n  class Pool { constructor(create){ this.create=create; this.items=[]; } get(){ return this.items.pop()||this.create(); } put(o){ this.items.push(o); } }\n  class Entity { constructor(){ this.x=0; this.y=0; this.w=24; this.h=24; this.vx=0; this.vy=0; this.alive=false; } rect(){ return {x:this.x,y:this.y,w:this.w,h:this.h}; } }\n  class Poop extends Entity { constructor(){ super(); this.kind='poop'; this.rot=0; this.speed=120; } spawn(x,y,speed){ this.x=x; this.y=y; this.speed=speed; this.vx=rand(-40,40); this.vy=this.speed; this.alive=true; this.w=this.h=rand(18,34); } step(dt){ this.vy += 220*dt*0.2; this.x += this.vx*dt; this.y += this.vy*dt; this.rot += this.vx*dt*0.02; } draw(g){ g.save(); g.translate(this.x+this.w/2, this.y+this.h/2); g.rotate(this.rot); g.fillStyle='#8b5a2b'; g.beginPath(); g.arc(0,0,this.w/2,0,Math.PI*2); g.fill(); g.fillStyle='#5b3a1b'; g.fillRect(-this.w*0.3, -this.h*0.1, this.w*0.6, this.h*0.6); g.restore(); } }\n  class PowerUp extends Entity { constructor(){ super(); this.kind='power'; this.type='shield'; } spawn(x,y,type){ this.x=x; this.y=y; this.type=type; this.vx=0; this.vy=90; this.alive=true; this.w=this.h=20; } step(dt){ this.y += this.vy*dt; } draw(g){ g.save(); g.translate(this.x+this.w/2, this.y+this.h/2); if(this.type==='shield'){ g.strokeStyle='#22c55e'; g.lineWidth=3; g.beginPath(); g.arc(0,0,this.w/2,0,Math.PI*2); g.stroke(); } else { g.fillStyle='#38bdf8'; g.fillRect(-this.w/2,-this.h/2,this.w,this.h); } g.restore(); } }\n  class Player extends Entity { constructor(){ super(); this.w=34; this.h=18; this.speed=240; this.shield=0; } draw(g){ g.fillStyle=this.shield>0?'#22c55e':'#e5e7eb'; g.fillRect(this.x, this.y, this.w, this.h); if(this.shield>0){ g.strokeStyle='#22c55e'; g.lineWidth=2; g.strokeRect(this.x-4,this.y-4,this.w+8,this.h+8); } } }\n  const hit=(a,b)=>!(a.x+a.w<b.x||b.x+b.w<a.x||a.y+a.h<b.y||b.y+b.h<a.y);\n\n  class Game{\n    constructor(canvas){\n      this.c=canvas; this.g=canvas.getContext('2d'); this.w=canvas.width; this.h=canvas.height;\n      this.player=new Player(); this.player.x=this.w/2-17; this.player.y=this.h-56;\n      this.poopPool=new Pool(()=>new Poop()); this.powerPool=new Pool(()=>new PowerUp());\n      this.poops=[]; this.powers=[];\n      this.score=0; this.best=Storage.getBest();\n      this.spawnTimer=0; this.spawnInterval=0.9; this.level=1; // levelì€ ë‚œì´ë„ ì§€í‘œ\n      this.alive=false; this.paused=false; this.slowmo=0; this.playerName = Storage.getName();\n      this.input={left:false,right:false,dragX:null};\n      this.last=now(); this.onFrame=this.onFrame.bind(this);\n      this.bindInput(); this.bindVisibility(); this.updateHUD();\n      // ì´ˆê¸° ë­í‚¹ ë Œë”\n      renderBoard(document.getElementById('leaderboard-list'), Storage.getBoard());\n      const nameInput = document.getElementById('player-name');\n      if(nameInput){ nameInput.value = this.playerName; }\n    }\n\n    bindInput(){\n      window.addEventListener('keydown',e=>{ if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') this.input.left=true; if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') this.input.right=true; if(e.key==='p'||e.key==='P') this.togglePause(); });\n      window.addEventListener('keyup',e=>{ if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') this.input.left=false; if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') this.input.right=false; });\n      const left=document.getElementById('btn-left'); const right=document.getElementById('btn-right');\n      const set=(b,v)=>{ if(!b) return; b.onpointerdown=()=>{ this.input[v]=true; Audio.ensure(); }; b.onpointerup=b.onpointercancel=()=>this.input[v]=false; };\n      set(left,'left'); set(right,'right');\n      this.c.addEventListener('pointerdown',e=>{ this.input.dragX=e.clientX; Audio.ensure(); Audio.resume(); });\n      window.addEventListener('pointermove',e=>{ if(this.input.dragX!=null){ const dx=e.clientX-this.input.dragX; this.player.x=clamp(this.player.x+dx*0.8, 0, this.w-this.player.w); this.input.dragX=e.clientX; }});\n      window.addEventListener('pointerup',()=>{ this.input.dragX=null; });\n\n      const startBtn = document.getElementById('btn-start');\n      const restartBtn = document.getElementById('btn-restart');\n      const pauseBtn = document.getElementById('btn-pause');\n      const resumeBtn = document.getElementById('btn-resume');\n      const soundBtn = document.getElementById('btn-sound');\n      const nameInput = document.getElementById('player-name');\n\n      if(startBtn) startBtn.onclick=()=>{\n        const name = sanitizeName(nameInput?.value||'');\n        if(!name){ nameInput?.focus(); nameInput?.classList.add('error'); setTimeout(()=>nameInput?.classList.remove('error'), 600); return; }\n        this.playerName = name; Storage.setName(name);\n        this.start();\n      };\n      if(restartBtn) restartBtn.onclick=()=>this.start();\n      if(pauseBtn) pauseBtn.onclick=()=>this.togglePause();\n      if(resumeBtn) resumeBtn.onclick=()=>this.togglePause(false);\n      if(soundBtn) soundBtn.onclick=()=>{ const on=Audio.toggle(); soundBtn.textContent=on?'ğŸ”Š':'ğŸ”‡'; };\n    }\n\n    bindVisibility(){ document.addEventListener('visibilitychange',()=>{ if(document.hidden) this.setPause(true); }); }\n    setPause(v){ this.paused=v; document.getElementById('pause-screen')?.classList.toggle('visible', this.alive && this.paused); }\n    togglePause(force){ if(!this.alive) return; this.setPause(force==null? !this.paused : !!force); }\n    updateHUD(){ document.getElementById('score').textContent=this.score|0; document.getElementById('best').textContent=this.best|0; }\n\n    start(){\n      this.reset(); this.alive=true;\n      document.getElementById('start-screen')?.classList.remove('visible');\n      document.getElementById('gameover-screen')?.classList.remove('visible');\n      requestAnimationFrame(this.onFrame);\n    }\n\n    gameover(){\n      this.alive=false;\n      document.getElementById('final-score').textContent=this.score|0;\n      // ë² ìŠ¤íŠ¸ ê°±ì‹ \n      if(this.score>this.best){ this.best=this.score; Storage.setBest(this.best); this.updateHUD(); }\n      // ì ìˆ˜ ì œì¶œ ë° ë³´ë“œ ë Œë”\n      const result = submitScore(this.playerName||'Player', this.score|0);\n      const rankLine = document.getElementById('rank-line');\n      rankLine.textContent = result.rank? `${this.playerName}ë‹˜ ë­í‚¹ ${result.rank}ìœ„!` : `${this.playerName}ë‹˜ì˜ ì ìˆ˜ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`;\n      renderBoard(document.getElementById('leaderboard-list-final'), result.board);\n      renderBoard(document.getElementById('leaderboard-list'), result.board);\n      document.getElementById('gameover-screen')?.classList.add('visible');\n    }\n\n    reset(){\n      this.score=0; this.level=1; this.spawnInterval=0.9; this.spawnTimer=0; this.slowmo=0;\n      this.player.x=this.w/2-17; this.player.y=this.h-56; this.player.shield=0;\n      for(const p of this.poops) this.poopPool.put(p); this.poops.length=0;\n      for(const p of this.powers) this.powerPool.put(p); this.powers.length=0;\n      this.last=now(); this.paused=false; this.updateHUD();\n    }\n\n    // ë‚œì´ë„: ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ìŠ¤í° ì£¼ê¸° ê°ì†Œ, ë‚™í•˜ ì†ë„ ì¦ê°€, ë™ì‹œ ìŠ¤í° í™•ë¥  ì¦ê°€\n    spawn(){\n      this.level += 0.02; // í”„ë ˆì„ê³¼ ë¬´ê´€í•˜ê²Œ ì„œì„œíˆ ì¦ê°€\n      const spawnMin = 0.16; // ìµœì†Œ ìŠ¤í° ê°„ê²©\n      const spawnBase = 0.9;\n      this.spawnInterval = Math.max(spawnMin, spawnBase - this.level*0.055);\n      const speed = 120 + this.level*22; // ì†ë„ë„ ì ì§„ ì¦ê°€\n      const duoProb = Math.min(0.35, 0.15 + this.level*0.03); // ë™ì‹œ ìŠ¤í° í™•ë¥  ì¦ê°€\n      const count = Math.random()<duoProb?2:1;\n      for(let i=0;i<count;i++){\n        const p=this.poopPool.get();\n        p.spawn(rand(0,this.w-24), -rand(24,140), speed*rand(0.9,1.3));\n        this.poops.push(p);\n      }\n      // íŒŒì›Œì—…ì€ ê³¼ë„í•˜ì§€ ì•Šê²Œ\n      if(Math.random()<Math.max(0.06, 0.14 - this.level*0.01)){\n        const t=Math.random()<0.6?'shield':'slow';\n        const pu=this.powerPool.get();\n        pu.spawn(rand(0,this.w-20), -40, t);\n        this.powers.push(pu);\n      }\n    }\n\n    step(dt){\n      const move=(this.input.left?-1:0)+(this.input.right?1:0);\n      const speedMod = (this.slowmo>0?0.6:1);\n      this.player.x=clamp(this.player.x+move*this.player.speed*dt*speedMod,0,this.w-this.player.w);\n      if(this.slowmo>0) this.slowmo -= dt;\n\n      this.spawnTimer -= dt;\n      if(this.spawnTimer<=0){ this.spawn(); this.spawnTimer = this.spawnInterval; }\n\n      const floor=this.h;\n      for(let i=this.poops.length-1;i>=0;i--){\n        const p=this.poops[i];\n        p.step(dt*(this.slowmo>0?0.5:1));\n        if(p.y>floor+60){ this.poops.splice(i,1); this.poopPool.put(p); this.score += 1; this.updateHUD(); }\n      }\n      for(let i=this.powers.length-1;i>=0;i--){\n        const p=this.powers[i];\n        p.step(dt);\n        if(p.y>floor+40){ this.powers.splice(i,1); this.powerPool.put(p); }\n      }\n\n      const pr=this.player.rect();\n      for(let i=this.powers.length-1;i>=0;i--){\n        const pu=this.powers[i];\n        if(hit(pr, pu.rect())){ this.powers.splice(i,1); this.powerPool.put(pu); if(pu.type==='shield'){ this.player.shield = Math.min(3, this.player.shield+1); Audio.beep(700,0.08,'triangle',0.12); } else { this.slowmo=2.0; Audio.beep(520,0.12,'sine',0.12); } }\n      }\n      for(let i=this.poops.length-1;i>=0;i--){\n        const p=this.poops[i];\n        if(hit(pr, p.rect())){ if(this.player.shield>0){ this.player.shield--; this.poops.splice(i,1); this.poopPool.put(p); Audio.beep(300,0.06,'square',0.12); } else { this.gameover(); Audio.beep(120,0.25,'sawtooth',0.14); return; } }\n      }\n    }\n\n    draw(){\n      const g=this.g; g.clearRect(0,0,this.w,this.h);\n      g.strokeStyle='rgba(255,255,255,0.05)'; g.lineWidth=1;\n      for(let y=0;y<this.h;y+=24){ g.beginPath(); g.moveTo(0,y); g.lineTo(this.w,y); g.stroke(); }\n      for(const p of this.poops) p.draw(g);\n      for(const p of this.powers) p.draw(g);\n      this.player.draw(g);\n      if(this.slowmo>0){ g.fillStyle='rgba(56,189,248,0.08)'; g.fillRect(0,0,this.w,this.h); }\n    }\n\n    onFrame(){ if(!this.alive) return; const t=now(); let dt=(t-this.last)/1000; this.last=t; dt=Math.min(dt,0.033); if(!this.paused){ this.step(dt); this.draw(); } requestAnimationFrame(this.onFrame); }\n  }\n\n  const canvas=document.getElementById('game');\n  const game=new Game(canvas);\n  window.__game=game;\n})();\n